<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
	xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout">
<head>
<link th:href="@{/css/board-header.css}" rel="stylesheet">
<link th:href="@{/css/page-css/mypage-myportfolio-detail.css}"
	rel="stylesheet">
<title>내 이력서</title>
</head>
<body>
	<div layout:fragment="content">
		<div class="container">

			<div class="myportfolio-title">
				<div
					th:replace="fragments/html/board-header :: board-header('내 이력서 > ' + ${portfolio.portfolioName})"></div>
			</div>
			<div class="embed-responsive embed-responsive-4by3 mb-3">
				<embed class="pdf-viewer embed-responsive-item"
					th:src="@{'/uploads/portfolio/' + ${portfolio.portfolioId} + '.pdf'}"
					type="application/pdf" width="100%" height="1030px" />
			</div>

			<!-- 버튼 4개 오른쪽 정렬 -->
			<div class="d-flex justify-content-end gap-2">
				<a href="/mypage/myportfolio" class="btn btn-primary">목록</a>

				<!-- 팝업창에서 원래 창으로 데이터 전송 -->
				<button th:data-portfolio-id="${portfolio.portfolioId}"
					th:data-portfolio-name="${portfolio.portfolioName}"
					onclick="confirmSelectedPortfolio(this)">이력서 선택</button>
				<!-- 팝업창에서 원래 창으로 데이터 전송 -->

			</div>
		</div>
		<div th:if="${errorMessage}" class="alert alert-danger" role="alert">
			<span th:text="${errorMessage}"></span>
		</div>
		<div th:if="${successMessage}" class="alert alert-success"
			role="alert">
			<span th:text="${successMessage}"></span>
		</div>
	</div>
	<script>
		// 선택한 이력서의 정보를 부모 창으로 전송하는 함수
		async function confirmSelectedPortfolio(buttonElement) {

			// 1. 버튼 요소에서 data-* 속성에 보관된 '데이터'를 추출합니다.
			const portfolioId = buttonElement.getAttribute('data-portfolio-id');
			const portfolioName = buttonElement
					.getAttribute('data-portfolio-name');
			
			//2. 추출한 데이터로 controller에 요청을 보내 PDF파일을 HTML로 변환한 문자열을 받습니다.
			let portfolioHTML = '';
			try{
				const response = await fetch(`/test-ajax3?use`);
				if(!response.ok){
					throw new Error(`HTTP error status: ${response.status}`)
				}
				// Http Response의 body(응답데이터)를 입력받음
				portfolioHTML = await response.text();
			} catch(error){
				console.error("Fetch Error:", error);
			}

			// 3. 부모 창의 함수에 '변환한 포트폴리오'를 전달하고 창을 닫습니다.
			window.opener.receiveDataFromPopup(portfolioHTML);
			window.close();
		}
	</script>
</body>
</html>