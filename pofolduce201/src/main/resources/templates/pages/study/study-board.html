<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
	xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
	layout:decorate="~{layouts/layout}">
<head>
<script type="text/javascript"
	src="//dapi.kakao.com/v2/maps/sdk.js?appkey=70c0de37da587509ef9f5d9da9f64303&libraries=services,places"></script>
<link th:href="@{/css/board-header.css}" rel="stylesheet">
<link th:href="@{/css/banner.css}" rel="stylesheet">
<link th:href="@{/css/study-css/study-board.css}" rel="stylesheet">
<title>스터디 게시판</title>
</head>
<div layout:fragment="content" class="main-content">
	<div
		th:replace="fragments/html/board-header :: board-header('스터디 게시판')"></div>
	<div id="map" class="map-container"></div>
	<div
		th:replace="fragments/html/banner :: banner('면접 및 취업 관련 스터디를 자유롭게 모아보세요!', '관련 없는 게시글 및 광고성 정보, 욕설이 포함된 게시글은 예고 없이 삭제될 수 있습니다.','스터디 모집 글을 올리실 때는 개인 정보 노출에 주의해 주세요!')"></div>
	<div class="study-table mt-3">
		<table class="table table-hover text-center">
			<colgroup>
				<col class="col-center" style="width: 3%">
				<col class="col-center" style="width: 10%">
				<col class="col-center" style="width: 20%">
				<col class="col-center" style="width: 37%">
				<col class="col-center" style="width: 15%">
				<col class="col-center" style="width: 15%">
			</colgroup>
			<thead>
				<tr>
					<th></th>
					<th scope="col">#</th>
					<th scope="col">작성자</th>
					<th scope="col">제목</th>
					<th scope="col">좋아요</th>
					<th scope="col">조회수</th>
				</tr>
			</thead>
			<tbody>
				<tr class="clickable-row"
					th:onclick="|window.location='/study/' + [[${first.studyId}]]|"
					th:if="${first != null}">
					<td><img alt="왕관" th:src="@{/svg/crown.svg}"
						class="img-fluid banner-image"></td>
					<th scope="row">1</th>
					<td th:text="${first.userId.nickname}"></td>
					<td th:text="${first.title}"></td>
					<td th:text="${first.likeCount}"></td>
					<td th:text="${first.viewCount}"></td>
				</tr>
				<tr class="clickable-row"
					th:onclick="|window.location='/study/' + [[${second.studyId}]]|"
					th:if="${second != null}">
					<td><img alt="왕관" th:src="@{/svg/2nd-crown.svg}"
						class="img-fluid banner-image"></td>
					<th scope="row">2</th>
					<td th:text="${second.userId.nickname}"></td>
					<td th:text="${second.title}"></td>
					<td th:text="${second.likeCount}"></td>
					<td th:text="${second.viewCount}"></td>
				</tr>
				<tr class="table-border-bottom clickable-row"
					th:onclick="|window.location='/study/' + [[${third.studyId}]]|"
					th:if="${third!= null}">
					<td><img alt="왕관" th:src="@{/svg/3rd-crown.svg}"
						class="img-fluid banner-image"></td>
					<th scope="row">3</th>
					<td th:text="${third.userId.nickname}"></td>
					<td th:text="${third.title}"></td>
					<td th:text="${third.likeCount}"></td>
					<td th:text="${third.viewCount}"></td>
				</tr>

				<tr class="clickable-row" th:each="list:${dateList}"
					th:onclick="|window.location='/study/' + [[${list.studyId}]]|"
					th:unless="${#lists.isEmpty(dateList)}">
					<td></td>
					<td th:text="${listStat.count}">#</td>
					<td th:text="${list.userId.nickname}">작성자</td>
					<td th:text="${list.title}">제목</td>
					<td th:text="${list.likeCount}">조회수</td>
					<td th:text="${list.viewCount}">조회수</td>
				</tr>
				<tr th:if="${#lists.isEmpty(dateList)}">
					<td colspan="5" class="text-center non-data">등록된 게시글이 없습니다.</td>
				</tr>
			</tbody>
		</table>
	</div>
	<div class="col text-end">
		<a class="btn btn-primary" href="/study/write"
			id="write-button">+</a>
	</div>
	<nav aria-label="Page navigation example" th:if="${totalPages > 0}">
		<ul class="pagination justify-content-center">
			<li class="page-item"
				th:classappend="${currentPage == 1} ? 'disabled'"><a
				class="page-link" th:href="@{/study(page=${currentPage - 1})}"
				tabindex="-1" aria-disabled="true">Previous</a></li>

			<li class="page-item"
				th:each="i : ${#numbers.sequence(1, totalPages)}"
				th:classappend="${i == currentPage} ? 'active'"><a
				class="page-link" th:href="@{/study(page=${i})}" th:text="${i}">1</a></li>

			<li class="page-item"
				th:classappend="${currentPage == totalPages} ? 'disabled'"><a
				class="page-link" th:href="@{/study(page=${currentPage + 1})}">Next</a></li>
		</ul>
	</nav>
	<script>
    // 카카오 지도 초기 설정
        var mapContainer = document.getElementById('map');
        var mapOption = {
            center: new kakao.maps.LatLng(37.583743027310, 126.999963317959),
            level: 1,
            draggable: true,
            scrollwheel: true 
        };
        var map = new kakao.maps.Map(mapContainer, mapOption);
        
        var geocoder = new kakao.maps.services.Geocoder();
        var ps = new kakao.maps.services.Places();
        var infoWindow = new kakao.maps.InfoWindow({zIndex:1});
        
        if (navigator.geolocation) {
            var options = {
                enableHighAccuracy: true,
                maximumAge: 0,
                timeout: 10000 
            };

            navigator.geolocation.getCurrentPosition(function(position) {
                var lat = position.coords.latitude,
                    lon = position.coords.longitude;
                var accuracy = position.coords.accuracy;
                
                console.log("현재 위치 정확도:", accuracy, "m");
                
                var locPosition = new kakao.maps.LatLng(lat, lon);
                
                map.setCenter(locPosition);
                
                var marker = new kakao.maps.Marker({
    				map: map,
   			 		position: locPosition
				});
                
                var infowindow = new kakao.maps.InfoWindow({
                    content: '<div class="map-hover">현재 위치</div>'
                });
                infowindow.open(map, marker);

            }, function(error) {
                console.error("위치 정보를 가져오는 데 실패했습니다.", error);
            }, options);
        } else {
            console.log("Geolocation API를 지원하지 않는 브라우저입니다.");
        }
        
        // ⭐ 서버 API에서 게시글 데이터 가져오기
        fetch('/study/api/map')
            .then(response => {
                if (!response.ok) {
                    throw new Error('네트워크 응답이 실패했습니다.');
                }
                return response.json();
            })
            .then(posts => {
                if (Array.isArray(posts) && posts.length > 0) {
                    posts.forEach(function(post) {
                        var address = post.address;
                        var studyId = post.studyId;
                        var title = post.title;
                        
                        // 주소 검색 시도
                        geocoder.addressSearch(address, function(result, status) {
                            if (status === kakao.maps.services.Status.OK) {
                                var coords = new kakao.maps.LatLng(result[0].y, result[0].x);
                                createMarkerWithEvents(coords, studyId, title);
                            } else {
                                // 주소 검색 실패 시 키워드 검색 시도
                                ps.keywordSearch(address, function(data, status) {
                                    if (status === kakao.maps.services.Status.OK) {
                                        var coords = new kakao.maps.LatLng(data[0].y, data[0].x);
                                        createMarkerWithEvents(coords, studyId, title);
                                    } else {
                                        console.error("키워드 검색 실패: " + address + ", 상태 코드: " + status);
                                    }
                                });
                            }
                        });
                    });
                } else {
                    console.log("표시할 주소 데이터가 없습니다.");
                }
            })
            .catch(error => console.error('주소 데이터를 불러오는 데 실패했습니다.', error));

        // ⭐ 마커와 이벤트를 생성하는 함수
        function createMarkerWithEvents(coords, studyId, title) {
            var marker = new kakao.maps.Marker({
                map: map,
                position: coords
            });

            // 마우스오버 이벤트: 인포윈도우 표시
            kakao.maps.event.addListener(marker, 'mouseover', function() {
                var content = `<div class="map-hover">${title}</div>`;
                infoWindow.setContent(content);
                infoWindow.open(map, marker);
            });

            // 마우스아웃 이벤트: 인포윈도우 닫기
            kakao.maps.event.addListener(marker, 'mouseout', function() {
                infoWindow.close();
            });

            // 클릭 이벤트: 게시글로 이동
            kakao.maps.event.addListener(marker, 'click', function() {
                window.location.href = '/study/' + studyId;
            });
        }
		document.addEventListener('DOMContentLoaded', function() {
			// 성공 메시지 표시
			if ('[[${successMessage}]]') {
				alert('[[${successMessage}]]');
			}
			// 에러 메시지 표시
			if ('[[${errorMessage}]]') {
				alert('[[${errorMessage}]]');
			}
		});
</script>
</div>
</html>