<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
	xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
	layout:decorate="~{layouts/layout}">
<head>
<link th:href="@{/css/board-header.css}" rel="stylesheet">
<link th:href="@{/css/study/study-board-post.css}" rel="stylesheet">
<script type="text/javascript"
	src="//dapi.kakao.com/v2/maps/sdk.js?appkey=70c0de37da587509ef9f5d9da9f64303"></script>

<title>게시글</title>
<style type="text/css">
.popover .popover-header {
	display: none;
}

.popover {
	max-width: 300px;
	background-color: #ffffff;
	border: 1px solid #FF4473;
	border-radius: 20px;
	text-align: center;
}

.popover-nickname {
	font-weight: bolder;
	font-size: 25px;
}

.popover hr {
	color: #FF4473;
}

.popover-content {
	color: #C5C5C5;
}

.popover-image {
	width: 30px;
	height: 30px;
	margin: auto;
}

.popover-button {
	width: 30px;
	height: 30px;
	font-size: 30px;
	background-color: #FF4473;
	cursor: pointer;
	border-radius: 50%;
	text-align: center;
	line-height: 27px;
	margin: auto;
}
</style>
</head>
<!--/* 
		body tag 는 명시하지 않는다  layout.html 의 content fragment 영역에 삽입될 부분이기 때문 
 */-->
<div layout:fragment="content" class="main-content">
	<div
		th:replace="fragments/html/board-header :: board-header('스터디 게시판 > 게시글 보기')"></div>
	<!-- 게시글 정보 -->
	<div class="title-area mb-3">

		<!-- 제목 + 버튼 영역 -->
		<div class="d-flex justify-content-between align-items-center mb-4"
			id="study-post-title">
			<h3 th:text="${post.title}" class="board-title mb-0">게시글 제목</h3>
			<div
				th:if="${session.userId != null and session.userId == post.userId.userId}">
				<div>
					<a th:href="@{/study/{studyId}/update(studyId=${post.studyId})}"
						class="btn btn-sm btn-primary">수정</a>
					<form
						th:action="@{/study/{studyId}/delete(studyId=${post.studyId})}"
						method="post" style="display: inline;">
						<button type="submit" class="btn btn-sm btn-primary"
							onclick="return confirmDelete();">삭제</button>
					</form>
				</div>
			</div>
		</div>

		<div class="d-flex align-items-center gap-3">

			<img alt="프로필" th:src="@{/svg/sejung.svg}" class="profile">

			<div class="d-flex flex-column">
				<p th:text="${post.userId.nickname}" class="mb-0 fw-bold nickname"
					th:attr="data-userid=${post.userId.userId}"
					data-bs-toggle="popover" title="사용자 정보">김세정</p>
				<p th:text="${postDateFormatted}" class="mb-0 text-muted small">2025-08-18</p>
			</div>

			<!-- 본인 게시글 아닌 경우에만 신고 버튼 -->
			<!-- 나중에 신고 추가 -->
			<div
				th:if="${session.userId != null and session.userId != post.userId.userId}">
				<img alt="신고" th:src="@{/svg/report-button.svg}" class="ms-auto"
					style="width: 20px; height: 20px;">
			</div>
		</div>

	</div>
	<!-- 게시글 내용 -->
	<div class="content-area">
		<div th:utext="${post.postHtml}" class="board-content">content</div>

		<div class="map-area">
			<p class="map-title">위치 정보</p>
			<div id="map" style="width: 800px; height: 300px;"></div>
		</div>
		<!-- 나중에 좋아요 기능 추가 -->
		<div class="text-center like-button">
			<button id="likeBtn" class="btn btn-primary not-liked" type="button">
				종아요<span id="likeCount" th:text="${post.likeCount}"></span>
			</button>
		</div>
	</div>
	<div class="comment-area">
		<div class="col text-end">
			<a class="btn btn-primary" href="/study" id="list-button">목록보기</a>
		</div>
		<div class="col">
			<p class="comment-title">댓글 목록</p>
		</div>
		<!-- 댓글 입력창 -->
		<div class="row">
			<form
				th:action="@{/study/{studyId}/comments(studyId=${post.studyId})}"
				method="post">
				<input type="hidden" name="userId" th:value="${session.userId}">
				<textarea class="form-control ps-3 pt-1" id="comment-content"
					name="comment-content" placeholder="댓글을 입력하세요." required></textarea>
				<div class="col text-end">
					<button class="btn btn-sm btn-primary" id="list-button"
						type="submit">댓글 작성</button>
				</div>
			</form>
		</div>
		<!-- 댓글 리스트 -->
		<div class="row comment-list" th:each="comment : ${comments}">
			<!-- 댓글 작성자 정보 -->
			<p>
				<strong th:text="${comment.userId.nickname}" tabindex="0"
					th:attr="data-userid=${comment.userId.userId}"
					data-bs-toggle="popover" data-bs-trigger="focus"
					class="comment-userName">작성자</strong> <span class="small"
					th:text="${#temporals.format(comment.commentsDate, 'yyyy-MM-dd HH:mm')}">작성일</span>
			</p>

			<p th:text="${comment.commentsContents}">댓글 내용</p>
			<!-- 수정, 삭제, 신고 버튼 -->
			<div class="col text-end">
				<!-- 본인 댓글일 때만 수정 및 삭제 버튼 -->
				<div
					th:if="${session.userId != null and session.userId == comment.userId.userId}">
					<div class="d-flex justify-content-end align-items-center gap-2">
						<!-- 수정 버튼 -->
						<button class="btn btn-sm btn-primary" type="button"
							th:onclick="|toggleEdit(${comment.commentsId})|">수정</button>
						<!-- 삭제 -->
						<form
							th:action="@{/study/{studyId}/comments/{commentId}/delete(studyId=${post.studyId}, commentId=${comment.commentsId})}"
							method="post" onsubmit="return confirmDelete();">
							<button class="btn btn-sm btn-primary" type="submit">삭제</button>
						</form>
					</div>
					<!-- 숨겨진 수정창 -->
					<div th:id="|edit-box-${comment.commentsId}|" class="hidden-update">
						<form
							th:action="@{/study/{studyId}/comments/{commentId}/edit(studyId=${post.studyId}, commentId=${comment.commentsId})}"
							method="post">
							<textarea class="form-control" name="comment-content"
								id="comment-content" th:text="${comment.commentsContents}"></textarea>
							<button class="btn btn-primary btn-sm mt-2" type="submit">수정
								완료</button>
						</form>
					</div>


				</div>
				<!-- 본인 댓글 아닐때만 신고 버튼 -->
				<div
					th:if="${session.userId != null and session.userId != comment.userId.userId}">
					<img alt="김세정" th:src="@{/svg/report-button.svg}" id="list-button">
				</div>
			</div>
		</div>
		<div class="comment-line"></div>
		<!-- 페이지네이션 -->
		<div class="comment-pagination mt-3">
			<ul class="pagination justify-content-center">
				<li class="page-item"
					th:classappend="${currentPage == 1}? 'disabled'"><a
					class="page-link"
					th:href="@{/study/{studyId}(studyId=${post.studyId}, page=${currentPage - 1})}">이전</a>
				</li>
				<li class="page-item"
					th:each="i : ${#numbers.sequence(1, totalPages)}"
					th:classappend="${i == currentPage}? 'active'"><a
					class="page-link"
					th:href="@{/study/{studyId}(studyId=${post.studyId}, page=${i})}"
					th:text="${i}">1</a></li>
				<li class="page-item"
					th:classappend="${currentPage == totalPages}? 'disabled'"><a
					class="page-link"
					th:href="@{/study/{studyId}(studyId=${post.studyId}, page=${currentPage + 1})}">다음</a>
				</li>
			</ul>
		</div>
	</div>
	<script>
		var container = document.getElementById('map');
		var options = {
			center : new kakao.maps.LatLng(37.583743027324, 126.999963317958),
			level : 1
		};

		var map = new kakao.maps.Map(container, options);
		function toggleEdit(commentId) {
			const editBox = document.getElementById("edit-box-" + commentId);
			// display가 none이면 보여주고, 아니면 숨김
			if (editBox.style.display === "none"
					|| editBox.style.display === "") {
				editBox.style.display = "block";
			} else {
				editBox.style.display = "none";
			}
		}
		function confirmDelete() {
			return confirm('정말 삭제하시겠습니까?');
		}
		document.addEventListener("DOMContentLoaded", function () {
		    const popoverTriggerList = document.querySelectorAll('[data-bs-toggle="popover"]');

		    popoverTriggerList.forEach(el => {
		        // Popover 초기화 (manual trigger)
		        const popover = new bootstrap.Popover(el, {
		            html: true,
		            title: '',
		            content: '불러오는 중...',
		            placement: 'top',
		            trigger: 'manual',
		            fallbackPlacements: []
		        });

		        // 닉네임 클릭 시 실행
		        el.addEventListener("click", async (e) => {
		            e.stopPropagation(); // 클릭 이벤트 버블링 방지
		            const userId = el.dataset.userid;

		            try {
		                const response = await fetch(`/api/user/${userId}`);
		                if (!response.ok) throw new Error("서버 응답 오류");

		                const data = await response.json();

		                const contentHtml = `
		                  <div>
		                    <div class="popover-image">
		                        <img src="/svg/crown.svg" alt="프로필" style="width:30px; height:30px;">
		                    </div>
		                    <p class="popover-nickname">${data.nickname}</p>
		                    <hr>
		                    <p class="popover-content">획득한 포인트: ${data.point}</p>
		                    <p class="popover-content">작성한 이력서: ${data.countPortfolio}</p>
		                    <p class="popover-content">작성한 첨삭: ${data.countReview}</p>
		                    <div class="popover-button">></div>
		                  </div>
		                `;

		                popover.setContent({ '.popover-body': contentHtml });
		                popover.show();

		                // 팝오버 내부 버튼 클릭 시 상세페이지 이동
		                const btn = document.querySelector('.popover-button');
		                if (btn) {
		                    btn.addEventListener("click", () => {
		                        window.location.href = `/userpage/${data.userId}`;
		                    });
		                }

		            } catch (err) {
		                console.error(err);
		                popover.setContent({ '.popover-body': '정보를 불러오지 못했습니다.' });
		                popover.show();
		            }
		        });
		    });

		    // 문서 클릭 시 팝오버 닫기
		    document.addEventListener('click', function (e) {
		        popoverTriggerList.forEach(el => {
		            const popoverInstance = bootstrap.Popover.getInstance(el);
		            if (popoverInstance &&
		                !el.contains(e.target) &&
		                !document.querySelector('.popover')?.contains(e.target)) {
		                popoverInstance.hide();
		            }
		        });
		    });
		});
	</script>
</div>

</html>